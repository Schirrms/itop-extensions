<?xml version="1.0" encoding="UTF-8"?>
<itop_design xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" version="1.2">
	<constants>
	</constants>
	<classes>
		<class id="Kubernetes" _delta="define">
			<parent>cmdbAbstractObject</parent>
			<properties>
				<category>bizmodel,searchable</category>
				<abstract>true</abstract>
				<key_type>autoincrement</key_type>
				<db_table>kubernetes</db_table>
				<db_key_field>id</db_key_field>
				<db_final_class_field>finalclass</db_final_class_field>
				<display_template/>
				<icon>images/kubernetes.png</icon>
				<reconciliation>
					<attributes>
						<attribute id="org_id"/>
						<attribute id="organization_name"/>
						<attribute id="finalclass"/>						
					</attributes>
				</reconciliation>
			</properties>
			<fields>
				<field id="description" xsi:type="AttributeText">
				  <sql>description</sql>
				  <default_value/>
				  <is_null_allowed>true</is_null_allowed>
				</field>
				<field id="org_id" xsi:type="AttributeExternalKey">
				  <sql>org_id</sql>
				  <target_class>Organization</target_class>
				  <is_null_allowed>false</is_null_allowed>
				  <on_target_delete>DEL_MANUAL</on_target_delete>
				  <filter>SELECT Organization WHERE id = :current_contact->org_id</filter>
				</field>
				<field id="organization_name" xsi:type="AttributeExternalField">
				  <extkey_attcode>org_id</extkey_attcode>
				  <target_attcode>name</target_attcode>
				</field>
				<field id="move2production" xsi:type="AttributeDate">
				  <sql>move2production</sql>
				  <default_value/>
				  <is_null_allowed>true</is_null_allowed>
				</field>
			</fields>
			<methods>
				<method id="DoCheckToWrite" _delta="define">
					<static>false</static>
					<access>protected</access>
					<type>Overload-DBObject</type>
					<code><![CDATA[	   public function DoCheckToWrite()
				{
					parent::DoCheckToWrite();
					// friendlyname has to be unique! Currently it' not possible to define this in datamodel (xml)
					
					$finalclass = $this->Get('finalclass');
					$nameSpec = MetaModel::GetNameSpec(get_class($this));
					$sFormat = preg_replace('/%[1-9]\$s/', '%s', $nameSpec['0']);
					$sArg = $nameSpec['1'];
					$oArg = array();
					
					/*
					 * 如果组成friendlyname的所有attribute都没有发生变化，那么不进行检查
					 * 如果不监听变化就进行检查，将导致对象无法更新
					 */
					$aChanges = $this->ListChanges();
					
					$isChanges = false;
					foreach($aChanges as $key=>$value)
					{   
						if(MetaModel::IsValidKeyAttCode($finalclass, $key))
						{   
							$extKeyFriends = MetaModel::GetExtKeyFriends($finalclass, $key);
							foreach($extKeyFriends as $k=>$v)
							{   
								if(in_array($k, $sArg))
								{   
									$isChanges = true;
								}
							}
						 
						}
						if(in_array($key, $sArg))
						{   
							$isChanges = true;
						}
					}
					
					foreach($sArg as $value) {
						array_push($oArg, $this->Get($value));
					}
					$sTypology = vsprintf("$sFormat", $oArg);
					//print_r($this->Get('name') . "<br>");
					//print_r($this->Get('brand_name') . "<br>");
					//print_r($this->Get('friendlyname') . "<br>");
					//print_r($oArg);
					//print_r("<br>");
					
					if($isChanges) {
						$oSearch = DBObjectSearch::FromOQL_AllData("SELECT $finalclass WHERE friendlyname=:friendlyname");
						$oSet = new DBObjectSet($oSearch, array(), array('friendlyname' => $sTypology));
						if ($oSet->Count() > 0)
						{
							$this->m_aCheckIssues[] = Dict::Format("Class:".$finalclass."/Error:".$finalclass."MustBeUnique", $sTypology);
						}
					}
				}]]></code>
				</method>			
			</methods>
			<presentation>
				<details>
					<items>
						<item id="org_id">
							<rank>10</rank>
						</item>
					</items>
				</details>	
				<search>
					<items>
						<item id="org_id">
							<rank>10</rank>
						</item>
					</items>					
				</search>
				<list>
					<items>
						<item id="org_id">
							<rank>10</rank>
						</item>
					</items>				
				</list>
			</presentation>
		</class>
		
		<class id="Deployment" _delta="define">
			<parent>Kubernetes</parent>
			<properties>
				<category>bizmodel,searchable</category>
				<abstract>false</abstract>
				<key_type>autoincrement</key_type>
				<db_table>deployment</db_table>
				<db_key_field>id</db_key_field>
				<db_final_class_field>finalclass</db_final_class_field>
				<naming>
					<attributes>
						<attribute id="k8snamespace_id"/>					
						<attribute id="applicationsolution_id"/>
					</attributes>
				</naming>
				<display_template/>
				<icon>images/deployment.png</icon>
				<reconciliation>
					<attributes>
						<attribute id="k8snamespace_id"/>					
						<attribute id="applicationsolution_id"/>
					</attributes>
				</reconciliation>
			</properties>
			<fields>
				<field id="k8snamespace_id" xsi:type="AttributeExternalKey">
					<sql>k8snamespace_id</sql>
					<target_class>K8sNamespace</target_class>
					<is_null_allowed>false</is_null_allowed>
					<on_target_delete>DEL_MANUAL</on_target_delete>
					<allow_target_creation>false</allow_target_creation>
				</field>
				<field id="k8snamespace_name" xsi:type="AttributeExternalField">
					<extkey_attcode>k8snamespace_id</extkey_attcode>
					<target_attcode>name</target_attcode>
				</field>
				<field id="applicationsolution_id" xsi:type="AttributeExternalKey">
					<sql>applicationsolution_id</sql>
					<target_class>ApplicationSolution</target_class>
					<is_null_allowed>false</is_null_allowed>
					<filter>SELECT ApplicationSolution AS app JOIN lnkPersonToSecret AS l ON l.applicationsolution_id = app.id WHERE l.contact_id = :current_contact_id</filter>
					<on_target_delete>DEL_AUTO</on_target_delete>
					<allow_target_creation>false</allow_target_creation>
				</field>
				<field id="applicationsolution_name" xsi:type="AttributeExternalField">
					<extkey_attcode>applicationsolution_id</extkey_attcode>
					<target_attcode>name</target_attcode>
				</field>
				<field id="type" xsi:type="AttributeEnum">
					<values>
						<value id="web">Web</value>
					</values>
					<sql>type</sql>
					<default_value>web</default_value>
					<is_null_allowed>false</is_null_allowed>
					<display_style>list</display_style>
				</field>
				<field id="image" xsi:type="AttributeURL">
					<sql>image</sql>
					<default_value/>
					<is_null_allowed>false</is_null_allowed>
				</field>
				<field id="url" xsi:type="AttributeURL">
					<sql>url</sql>
					<default_value/>
					<is_null_allowed>true</is_null_allowed>
				</field>
				<field id="status" xsi:type="AttributeEnum">
					<values>
						<value id="production">production</value>
						<value id="stock">stock</value>
					</values>
					<sql>status</sql>
					<default_value>production</default_value>
					<is_null_allowed>true</is_null_allowed>
					<display_style>list</display_style>
				</field>
				<field id="containerport" xsi:type="AttributeInteger">
					<sql>containerport</sql>
					<default_value>80</default_value>
					<is_null_allowed>false</is_null_allowed>
				</field>
				<field id="replicas" xsi:type="AttributeInteger">
					<sql>replicas</sql>
					<default_value>3</default_value>
					<is_null_allowed>false</is_null_allowed>
				</field>
			</fields>
			<methods>
			</methods>
			<presentation>
				<details>
					<items>
						<item id="k8snamespace_id">
							<rank>10</rank>
						</item>
						<item id="applicationsolution_id">
							<rank>15</rank>
						</item>
						<item id="type">
							<rank>20</rank>
						</item>
						<item id="status">
							<rank>30</rank>
						</item>
						<item id="image">
							<rank>40</rank>
						</item>
						<item id="replicas">
							<rank>50</rank>
						</item>
						<item id="containerport">
							<rank>60</rank>
						</item>
						<item id="org_id">
							<rank>70</rank>
						</item>
						<item id="move2production">
							<rank>80</rank>
						</item>
						<item id="description">
							<rank>90</rank>
						</item>
						<item id="url">
							<rank>100</rank>
						</item>
					</items>
				</details>
				<search>
					<items>
						<item id="k8snamespace_id">
							<rank>10</rank>
						</item>
						<item id="applicationsolution_id">
							<rank>15</rank>
						</item>
						<item id="type">
							<rank>20</rank>
						</item>
						<item id="status">
							<rank>30</rank>
						</item>
						<item id="image">
							<rank>40</rank>
						</item>
						<item id="replicas">
							<rank>50</rank>
						</item>
						<item id="containerport">
							<rank>60</rank>
						</item>
						<item id="org_id">
							<rank>70</rank>
						</item>
						<item id="move2production">
							<rank>80</rank>
						</item>
						<item id="description">
							<rank>90</rank>
						</item>
						<item id="url">
							<rank>100</rank>
						</item>
					</items>
				</search>
				<list>
					<items>
						<item id="k8snamespace_id">
							<rank>10</rank>
						</item>
						<item id="applicationsolution_id">
							<rank>15</rank>
						</item>
						<item id="type">
							<rank>20</rank>
						</item>
						<item id="status">
							<rank>30</rank>
						</item>
						<item id="image">
							<rank>40</rank>
						</item>
						<item id="replicas">
							<rank>50</rank>
						</item>
						<item id="containerport">
							<rank>60</rank>
						</item>
						<item id="org_id">
							<rank>70</rank>
						</item>
						<item id="move2production">
							<rank>80</rank>
						</item>
					</items>
				</list>
			</presentation>
		</class>
		
		<class id="Ingress" _delta="define">
			<parent>Kubernetes</parent>
			<properties>
				<category>bizmodel,searchable</category>
				<abstract>false</abstract>
				<key_type>autoincrement</key_type>
				<db_table>ingress</db_table>
				<db_key_field>id</db_key_field>
				<db_final_class_field>finalclass</db_final_class_field>
				<naming>
					<attributes>
						<attribute id="applicationsolution_id"/>
						<attribute id="domain_id"/>
						<attribute id="location"/>
					</attributes>
				</naming>
				<display_template/>
				<icon>images/ingress.png</icon>
				<reconciliation>
					<attributes>
						<attribute id="applicationsolution_id"/>
						<attribute id="domain_id"/>
						<attribute id="location"/>
					</attributes>
				</reconciliation>
			</properties>
			<fields>
				<field id="k8snamespace_id" xsi:type="AttributeExternalKey">
					<sql>k8snamespace_id</sql>
					<target_class>K8sNamespace</target_class>
					<is_null_allowed>false</is_null_allowed>
					<on_target_delete>DEL_MANUAL</on_target_delete>
					<allow_target_creation>false</allow_target_creation>
				</field>
				<field id="k8snamespace_name" xsi:type="AttributeExternalField">
					<extkey_attcode>k8snamespace_id</extkey_attcode>
					<target_attcode>name</target_attcode>
				</field>
				<field id="applicationsolution_id" xsi:type="AttributeExternalKey">
					<sql>applicationsolution_id</sql>
					<target_class>ApplicationSolution</target_class>
					<is_null_allowed>false</is_null_allowed>
					<filter>SELECT ApplicationSolution AS app JOIN lnkPersonToSecret AS l ON l.applicationsolution_id = app.id WHERE l.contact_id = :current_contact_id</filter>
					<on_target_delete>DEL_AUTO</on_target_delete>
					<allow_target_creation>false</allow_target_creation>
				</field>
				<field id="applicationsolution_name" xsi:type="AttributeExternalField">
					<extkey_attcode>applicationsolution_id</extkey_attcode>
					<target_attcode>name</target_attcode>
				</field>
				<field id="domain_id" xsi:type="AttributeExternalKey">
					<sql>domain_id</sql>
					<target_class>Domain</target_class>
					<is_null_allowed>false</is_null_allowed>
					<filter>SELECT Domain AS d JOIN lnkApplicationSolutionToFunctionalCI AS l ON l.functionalci_id=d.id WHERE l.applicationsolution_id = :this->applicationsolution_id</filter>
					<on_target_delete>DEL_AUTO</on_target_delete>
					<dependencies>
						<attribute id="applicationsolution_id"/>
					</dependencies>
				</field>
				<field id="location" xsi:type="AttributeString">
					<sql>location</sql>
					<default_value>/</default_value>
					<is_null_allowed>false</is_null_allowed>
				</field>
				<field id="serviceport" xsi:type="AttributeInteger">
					<sql>serviceport</sql>
					<default_value>80</default_value>
					<is_null_allowed>false</is_null_allowed>
				</field>
				<field id="status" xsi:type="AttributeEnum">
					<values>
						<value id="production">production</value>
						<value id="stock">stock</value>
					</values>
					<sql>status</sql>
					<default_value>production</default_value>
					<is_null_allowed>true</is_null_allowed>
					<display_style>list</display_style>
				</field>			
			</fields>
			<methods>
			</methods>
			<presentation>
				<details>
					<items>
						<item id="k8snamespace_id">
							<rank>10</rank>
						</item>
						<item id="applicationsolution_id">
							<rank>15</rank>
						</item>
						<item id="domain_id">
							<rank>40</rank>
						</item>
						<item id="location">
							<rank>50</rank>
						</item>
						<item id="serviceport">
							<rank>60</rank>
						</item>
						<item id="status">
							<rank>70</rank>
						</item>
						<item id="org_id">
							<rank>75</rank>
						</item>
						<item id="move2production">
							<rank>80</rank>
						</item>
						<item id="description">
							<rank>90</rank>
						</item>
					</items>
				</details>
				<search>
					<items>
						<item id="k8snamespace_id">
							<rank>10</rank>
						</item>
						<item id="applicationsolution_id">
							<rank>15</rank>
						</item>
						<item id="domain_id">
							<rank>40</rank>
						</item>
						<item id="location">
							<rank>50</rank>
						</item>
						<item id="serviceport">
							<rank>60</rank>
						</item>
						<item id="status">
							<rank>70</rank>
						</item>
						<item id="org_id">
							<rank>75</rank>
						</item>
						<item id="move2production">
							<rank>80</rank>
						</item>
					</items>
				</search>
				<list>
					<items>
						<item id="k8snamespace_id">
							<rank>10</rank>
						</item>
						<item id="applicationsolution_id">
							<rank>15</rank>
						</item>
						<item id="domain_id">
							<rank>40</rank>
						</item>
						<item id="location">
							<rank>50</rank>
						</item>
						<item id="serviceport">
							<rank>60</rank>
						</item>
						<item id="status">
							<rank>70</rank>
						</item>
						<item id="org_id">
							<rank>75</rank>
						</item>
						<item id="move2production">
							<rank>80</rank>
						</item>
					</items>
				</list>
			</presentation>
		</class>

		<class id="Secret" _delta="define">
			<parent>Kubernetes</parent>
			<properties>
				<category>bizmodel,searchable</category>
				<abstract>false</abstract>
				<key_type>autoincrement</key_type>
				<db_table>secret</db_table>
				<db_key_field>id</db_key_field>
				<db_final_class_field>finalclass</db_final_class_field>
				<naming>
					<attributes>
						<attribute id="name"/>
					</attributes>
				</naming>
				<display_template/>
				<icon>images/secret.png</icon>
				<reconciliation>
					<attributes>
						<attribute id="name"/>
					</attributes>
				</reconciliation>
			</properties>
			<fields>
				<field id="name" xsi:type="AttributeString">
					<sql>name</sql>
					<default_value/>
					<is_null_allowed>false</is_null_allowed>
				</field>
				<field id="data" xsi:type="AttributeText">
					<sql>data</sql>
					<is_null_allowed>false</is_null_allowed>
					<default_value>KEY:VALUE</default_value>
				</field>
				<field id="person_list" xsi:type="AttributeLinkedSetIndirect">
					<linked_class>lnkPersonToSecret</linked_class>
					<ext_key_to_me>secret_id</ext_key_to_me>
					<count_min>0</count_min>
					<count_max>0</count_max>
					<ext_key_to_remote>person_id</ext_key_to_remote>
					<duplicates/>					
				</field>			
			</fields>
			<methods>
			</methods>
			<presentation>
				<details>
					<items>
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="data">
							<rank>11</rank>
						</item>
						<item id="description">
							<rank>15</rank>
						</item>
						<item id="org_id">
							<rank>40</rank>
						</item>
						<item id="move2production">
							<rank>50</rank>
						</item>
						<item id="person_list">
							<rank>60</rank>
						</item>
					</items>
				</details>
				<search>
					<items>
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="description">
							<rank>15</rank>
						</item>
						<item id="org_id">
							<rank>40</rank>
						</item>
						<item id="move2production">
							<rank>50</rank>
						</item>
					</items>
				</search>
				<list>
					<items>
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="description">
							<rank>15</rank>
						</item>
						<item id="org_id">
							<rank>40</rank>
						</item>
						<item id="move2production">
							<rank>50</rank>
						</item>					
					</items>
				</list>
			</presentation>
		</class>	

		<class id="K8sNamespace" _delta="define">
			<parent>Typology</parent>
			<properties>
				<category>bizmodel,searchable</category>
				<abstract>false</abstract>
				<key_type>autoincrement</key_type>
				<db_table>k8snamespace</db_table>
				<db_key_field>id</db_key_field>
				<db_final_class_field>finalclass</db_final_class_field>
				<naming>
					<attributes>
						<attribute id="name"/>
					</attributes>
				</naming>
				<display_template/>
				<icon>images/secret.png</icon>
				<reconciliation>
					<attributes>
						<attribute id="name"/>
					</attributes>
				</reconciliation>
			</properties>
			<fields>
				<field id="domain" xsi:type="AttributeString">
					<sql>domain</sql>
					<default_value/>
					<is_null_allowed>false</is_null_allowed>
				</field>
				<field id="note" xsi:type="AttributeString">
					<sql>note</sql>
					<default_value/>
					<is_null_allowed>true</is_null_allowed>
				</field>
				<field id="deployment_list" xsi:type="AttributeLinkedSet">
					<linked_class>Deployment</linked_class>
					<ext_key_to_me>k8snamespace_id</ext_key_to_me>
					<edit_mode>add_only</edit_mode>
					<count_min>0</count_min>
					<count_max>0</count_max>
					<duplicates/>					
				</field>
				<field id="ingress_list" xsi:type="AttributeLinkedSet">
					<linked_class>Ingress</linked_class>
					<ext_key_to_me>k8snamespace_id</ext_key_to_me>
					<edit_mode>add_only</edit_mode>
					<count_min>0</count_min>
					<count_max>0</count_max>
					<duplicates/>					
				</field>				
			</fields>
			<methods>
			</methods>
			<presentation>
				<details>
					<items>
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="domain">
							<rank>12</rank>
						</item>
						<item id="note">
							<rank>15</rank>
						</item>
						<item id="deployment_list">
							<rank>40</rank>
						</item>
						<item id="ingress_list">
							<rank>40</rank>
						</item>						
					</items>
				</details>
				<search>
					<items>
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="domain">
							<rank>12</rank>
						</item>						
						<item id="note">
							<rank>15</rank>
						</item>
						<item id="deployment_list">
							<rank>40</rank>
						</item>
						<item id="ingress_list">
							<rank>40</rank>
						</item>					
					</items>
				</search>
				<list>
					<items>
						<item id="name">
							<rank>10</rank>
						</item>
						<item id="domain">
							<rank>12</rank>
						</item>						
						<item id="note">
							<rank>15</rank>
						</item>
					</items>
				</list>
			</presentation>
		</class>

		<class id="lnkPersonToSecret" _delta="define">
			<parent>cmdbAbstractObject</parent>
			<properties>
				<is_link>1</is_link>
				<category>bizmodel</category>
				<abstract>false</abstract>
				<key_type>autoincrement</key_type>
				<db_table>lnkpersontosecret</db_table>
				<db_key_field>id</db_key_field>
				<db_final_class_field/>
				<naming>
					<attributes>
						<attribute id="person_id"/>
						<attribute id="secret_id"/>
					</attributes>
				</naming>
				<display_template/>
				<icon/>
				<reconciliation>
					<attributes>
						<attribute id="person_id"/>
						<attribute id="secret_id"/>
					</attributes>
				</reconciliation>
			</properties>
			<fields>
				<field id="person_id" xsi:type="AttributeExternalKey">
					<sql>person_id</sql>
					<target_class>Person</target_class>
					<is_null_allowed>false</is_null_allowed>
					<on_target_delete>DEL_AUTO</on_target_delete>
				</field>
				<field id="person_name" xsi:type="AttributeExternalField">
					<extkey_attcode>person_id</extkey_attcode>
					<target_attcode>friendlyname</target_attcode>
				</field>
				<field id="secret_id" xsi:type="AttributeExternalKey">
					<sql>secret_id</sql>
					<target_class>Secret</target_class>
					<is_null_allowed>false</is_null_allowed>
					<on_target_delete>DEL_AUTO</on_target_delete>
				</field>
				<field id="secret_name" xsi:type="AttributeExternalField">
					<extkey_attcode>secret_id</extkey_attcode>
					<target_attcode>name</target_attcode>
				</field>
			</fields>
			<methods>
				<method id="ReloadAndDisplayCustom" _delta="define">
					<static>false</static>
					<access>public</access>
					<type>Custom</type>
					<code><![CDATA[
					function ReloadAndDisplayCustom($oPage, $oObj, $sMessageId = '', $sMessage = '', $sSeverity = null)
					{
						$oAppContext = new ApplicationContext();
						if ($sMessageId != '')
						{
							cmdbAbstractObject::SetSessionMessage(get_class($oObj), $oObj->GetKey(), $sMessageId, $sMessage, $sSeverity, 0, true /* must not exist */);
						}
						
						$oId = $oObj->getKey();
						$oPage->add_header('Location: '.utils::GetAbsoluteUrlAppRoot().'pages/UI.php?operation=details&class='.get_class($oObj).'&id='.$oId.'&'.$oAppContext->GetForLink());
					}
					]]>
					</code>
				</method>			
				<method id="DisplayModifyForm" _delta="define">
					<static>false</static>
					<access>public</access>
					<type>Overload-cmdbAbstractObject</type>
					<code><![CDATA[
						public function DisplayModifyForm(WebPage $oPage, $aExtraParams = array())
						{
							if(!UserRights::IsAdministrator())
							{
								$sMesg = Dict::Format("Class:lnkPersonToSecret/Error:NotAllowDirectCreation", get_class($this));
								if($this->IsNew())
								{
									$sMesg = $sMesg . '...<a href="'.utils::GetAbsoluteUrlAppRoot().'pages/UI.php?operation=modify&class=Person&id='.UserRights::GetContactId().'">'.Dict::Format("Class:lnkPersonToSecret/Msg:EditMySelf").'</a>';
									$oPage->add("<div class=\"header_message message_info\">$sMesg</div>\n");
								}else
								{
									self::ReloadAndDisplayCustom($oPage, $this, 'lnkpersontosecret-no-direct', $sMesg, 'info');
								}
							}else
							{
								parent::DisplayModifyForm($oPage, $aExtraParams);
							}
						}
					]]>
					</code>
				</method>			
				<method id="DoCheckToWrite" _delta="define">
					<static>false</static>
					<access>protected</access>
					<type>Overload-DBObject</type>
					<code><![CDATA[  public function DoCheckToWrite(){
			/* 允许研发编辑secret时添加删除联系人, 取消这里的检查
			$myContactId = UserRights::GetContactId();
			$thisContactId = $this->Get('person_id');
			$thisContactName = $this->Get('contact_name');
			if ($myContactId != $thisContactId && !UserRights::IsAdministrator()){
				$this->m_aCheckIssues[] = Dict::Format("Class:lnkPersonToSecret/Error:CanOnlyAddLinkForYourself", $thisContactName);
			}
			*/
			
			$aChanges = $this->ListChanges();
			if($aChanges)
			{
				$friendlyname = $this->Get('person_id') . " " . $this->Get('secret_id');
				if(!$this->IsNew())
				{
					$this->m_aCheckIssues[] = Dict::Format("Class:lnkPersonToSecret/Error:OnlyAddAndDeleteIsAllow", $friendlyname);				
				}else
				{
					$oSearch = DBObjectSearch::FromOQL_AllData("SELECT lnkPersonToSecret WHERE friendlyname=:friendlyname");
					$oSet = new DBObjectSet($oSearch, array(), array("friendlyname" => $friendlyname));
					
					if ($oSet->Count() > 0)
					{
						$this->m_aCheckIssues[] = Dict::Format("Class:lnkPersonToSecret/Error:ThisLnkAlreadyExists", $friendlyname);
					}				
				}
			}
		}]]>
					</code>
				</method>
				<method id="CheckToDelete" _delta="define">
					<static>false</static>
					<access>protected</access>
					<type>Overload-DBObject</type>
					<code><![CDATA[	   
  	public function CheckToDelete(&$oDeletionPlan)
  	{
		$myContactId = UserRights::GetContactId();
		$thisContactId = $this->Get('person_id');
  		if ($myContactId != $thisContactId && !UserRights::IsAdministrator())
		{
			// 普通用户不允许删除非自己名下的lnkPersonToSecret
			$oDeletionPlan->AddToDelete($this, null);
			$oDeletionPlan->SetDeletionIssues($this, array('只能删除自己名下的关联'), true);
			$oDeletionPlan->ComputeResults();
			return false;
		}
		return parent::CheckToDelete($oDeletionPlan);
  	} 
			]]></code>
				</method>

			</methods>
			<presentation>
				<details>
					<items>
						<item id="secret_id">
							<rank>10</rank>
						</item>
						<item id="person_id">
							<rank>20</rank>
						</item>						
					</items>
				</details>
				<search>
					<items>
						<item id="secret_id">
							<rank>10</rank>
						</item>
						<item id="person_id">
							<rank>20</rank>
						</item>						
					</items>
				</search>
				<list>
					<items>
						<item id="secret_id">
							<rank>10</rank>
						</item>
						<item id="person_id">
							<rank>20</rank>
						</item>						
					</items>
				</list>
			</presentation>
		</class>		
	</classes>
	<menus>
	</menus>
</itop_design>
